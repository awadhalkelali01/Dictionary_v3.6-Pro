<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“˜ Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø·Ø§Ù„Ø¨ â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª (Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù‘Ù†Ø©)</title>
<style>
:root{
  --primary:#0b63a8;
  --primary-light:#00aaff;
  --card:#ffffff;
  --border:#d9e6f2;
  --text:#222;
  --radius:12px;
  --shadow: 0 8px 24px rgba(0,0,0,.06);
}

/* Ø«ÙŠÙ…: ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ø¹Ø¨Ø± body.classList.add('theme-...') */
body.theme-blue { --primary:#0b63a8; --primary-light:#00aaff; }
body.theme-green { --primary:#15803d; --primary-light:#4ade80; }
body.theme-purple { --primary:#7c3aed; --primary-light:#c084fc; }
body.theme-grey { --primary:#4b5563; --primary-light:#9ca3af; }

*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Segoe UI",Tahoma,Arial,system-ui;
  background:#f6f9fc;
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  direction:rtl;
}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± */
.app-header{
  background: linear-gradient(90deg,var(--primary),var(--primary-light));
  color:#fff;
  padding:12px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  box-shadow:var(--shadow);
}
.app-header h1{ margin:0; font-size:1.15rem; font-weight:800; }

/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
.container{ max-width:980px; margin:18px auto; padding:18px; }

/* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
.table-wrap {
  background:var(--card);
  border-radius:var(--radius);
  padding:14px;
  box-shadow:var(--shadow);
}

/* ØªØ­ÙƒÙ… Ø¹Ø§Ù… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
#dictionaryTable {
  width:100%;
  border-collapse:collapse;
  table-layout:auto;
  font-size:0.99rem;
}
#dictionaryTable th, #dictionaryTable td{
  padding:10px 8px; border-bottom:1px solid var(--border); vertical-align:middle;
}
#dictionaryTable thead th{ background:var(--primary); color:#fff; font-weight:800; 
}

/* Ø£Ø¹Ù…Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø© */
#dictionaryTable th.num-col, #dictionaryTable td.num-col { width:44px; text-align:center; }
#dictionaryTable th.check-col, #dictionaryTable td.check-col { width:44px; text-align:center; }
#dictionaryTable th.word-col, #dictionaryTable td.word-col {
  width: auto;              /* ÙƒØ§Ù† 140px */
  min-width: 150px;          /* ÙŠÙ…Ù†Ø¹ ØªÙ…Ø¯Ø¯ Ø²Ø§Ø¦Ø¯ */
  text-align: center;
  direction: ltr;
  font-weight: 800;
  white-space: normal;        /* ÙŠØ³Ù…Ø­ Ø¨ÙƒØ³Ø± Ø§Ù„Ø³Ø·Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶Ø±ÙˆØ±Ø© */
  word-break: break-word;     /* ÙŠÙ…Ù†Ø¹ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù†Øµ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
}

#dictionaryTable th.meaning-col, #dictionaryTable td.meaning-col {
  width: auto;              /* ÙƒØ§Ù† 140px */
  min-width: 150px;
  text-align: center;
  direction: rtl;
  white-space: normal;
  word-break: break-word;
}

#dictionaryTable th.eng-sentence-col, #dictionaryTable td.eng-sentence-col {
  width:35%;
  text-align:left;
  direction:ltr;
  white-space:normal;
  word-break:break-word;
}
#dictionaryTable th.ar-sentence-col, #dictionaryTable td.ar-sentence-col {
  width:30%;
  text-align:right;
  direction:rtl;
  white-space:normal;
  word-break:break-word;
}
#dictionaryTable th.actions-col, #dictionaryTable td.actions-col {
  width: 210px;     /* ÙˆØ³Ù‘Ø¹Øª Ù„Ùƒ Ø§Ù„Ø¹Ù…ÙˆØ¯ */
  white-space: nowrap;  
  text-align:center;
}
.actions-col .icon-btn{
  margin: 0 6px;
}
#dictionaryTable tbody tr:nth-child(even){
  background:#f2f7fb;
}
#dictionaryTable tbody tr:nth-child(odd){
  background:#ffffff;
}

/* Ø£Ø²Ø±Ø§Ø± */
.btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
.btn-main { background:linear-gradient(90deg,var(--primary),var(--primary-light)); color:#fff; }
.btn-sec { background:#fff; color:var(--primary); border:1px solid var(--border); }
.btn-danger { background:#fff0f0; color:#c23; border:1px solid rgba(194,35,35,0.1); }

/* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø²Ø± */
.icon-btn { background:none; border:none; cursor:pointer; font-size:1.15rem; color:var(--primary); padding:4px; }

/* Ù…Ø³Ø§Ø­Ø§Øª ØªØ­ÙƒÙ… */
.controls { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; margin-bottom:10px; }
.small-note { font-size:0.95rem; color:#666; }
.count-badge { font-weight:800; color:var(--primary); }

/* Ù…ÙˆØ¯Ø§Ù„ */
#sharedModalBackdrop {
  position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:9999;
}
#sharedModal {
  background:var(--card); width:92%; max-width:520px; border-radius:12px; padding:18px; box-shadow:var(--shadow); text-align:right;
}

/* toast */
#toast {
  position:fixed; left:50%; transform:translateX(-50%); bottom:22px;
  background:var(--primary); color:#fff; padding:10px 14px; border-radius:10px; z-index:10000; opacity:0; transition:opacity .2s;
}

/* footer */
.app-footer {
  text-align:center; padding:10px 0; color:#555; font-size:0.95rem;
  position:fixed; left:0; right:0; bottom:0; background:rgba(255,255,255,0.9); backdrop-filter:blur(4px);
  border-top:1px solid rgba(0,0,0,0.04);
}

/* responsive */
@media(max-width:760px){
  #dictionaryTable th, #dictionaryTable td{ font-size:0.88rem; padding:8px; }
  #dictionaryTable th.actions-col, #dictionaryTable td.actions-col { width:120px; }
  #dictionaryTable th.word-col, #dictionaryTable td.word-col { width:110px; }
  #dictionaryTable th.meaning-col, #dictionaryTable td.meaning-col { width:110px; }
  #dictionaryTable th.eng-sentence-col, #dictionaryTable td.eng-sentence-col,
  #dictionaryTable th.ar-sentence-col, #dictionaryTable td.ar-sentence-col { width:auto; }
}
</style>
</head>
<body>

<header class="app-header">
  <button class="icon-btn" id="backHome" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">ğŸ </button>
  <h1>ğŸ“˜ Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø·Ø§Ù„Ø¨</h1>
  <div></div>
</header>

<main class="container">
  <div class="table-wrap">

    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
      <div>
        <div style="font-weight:800;font-size:1.03rem;" id="headerTitle">ğŸ“˜ Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø·Ø§Ù„Ø¨</div>
        <div id="headerSub" class="small-note" style="margin-top:6px;"></div>
      </div>

      <div class="controls" role="region" aria-label="Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…">
        <button class="btn btn-main" id="openAddModal">Ø£Ø¶Ù ÙƒÙ„Ù…Ø©</button>
        <button class="btn btn-sec" id="insertHereBtn">Ø£Ø¶Ù Ø¨ÙŠÙ† Ø§Ù„ØµÙÙˆÙ</button>
        <button class="btn btn-sec" id="exportJsonBtn">ØªØµØ¯ÙŠØ± JSON</button>
        <button class="btn btn-sec" id="exportXmlBtn">ØªØµØ¯ÙŠØ± XML</button>
        <button class="btn btn-sec" id="importBtn">Ø§Ø³ØªÙŠØ±Ø§Ø¯ (Ø¯Ù…Ø¬/Ø§Ø³ØªØ¨Ø¯Ø§Ù„)</button>
        <input type="file" id="fileInput" accept=".json,.xml" style="display:none">
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
      <div class="small-note">Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: <span id="wordCount" class="count-badge">0</span></div>
      <div style="text-align:left;">
        <label style="font-size:0.95rem"><input type="checkbox" id="autoCap"> Ø¶Ø¨Ø· Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ù„ØªØ±Ù‚ÙŠÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</label>
      </div>
    </div>

    <table id="dictionaryTable" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª" style="margin-top:12px;">
      <thead>
        <tr>
          <th class="check-col"><input type="checkbox" id="selectAll" aria-label="ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„"></th>
          <th class="num-col">#</th>
          <th class="word-col">Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</th>
          <th class="meaning-col">Ø§Ù„Ù…Ø¹Ù†Ù‰ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ</th>
          <th class="eng-sentence-col">Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</th>
          <th class="ar-sentence-col">ØªØ±Ø¬Ù…Ø© / ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø¬Ù…Ù„Ø©</th>
          <th class="actions-col">ÙˆØ¸Ø§Ø¦Ù</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;">
      <button class="btn btn-danger" id="deleteSelectedBtn">Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
      <button class="btn btn-sec" id="clearAllBtn">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
    </div>

  </div>
</main>

<footer class="app-footer">â¤ï¸â¤ï¸ ØªØµÙ…ÙŠÙ… ÙˆØªÙ†ÙÙŠØ°: <b>Ø£Ø¨Ùˆ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡</b> â€” Ù‡Ø¯ÙŠØ© Ù…Ù† Ø£Ø¨ Ù„Ø£Ø¨Ù†Ø§Ø¦Ù‡ â¤ï¸â¤ï¸</footer>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ù…Ø´ØªØ±Ùƒ -->
<div id="sharedModalBackdrop">
  <div id="sharedModal"></div>
</div>
<div id="toast"></div>

<script>
/* ====== Ø¯Ø¹Ù… Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ù…Ø·Ø¨Ù‚ Ø³Ø§Ø¨Ù‚Ù‹Ø§ ====== */
document.body.classList.add(localStorage.getItem("theme") || "theme-blue");

/* ====== Ù…ÙˆØ¯Ø§Ù„ ØµØºÙŠØ± + Ø£Ø¯ÙˆØ§Øª ØªÙØ§Ø¹Ù„ (Ù…Ù‚Ø±ÙˆØ¡ ÙˆÙˆØ§Ø¶Ø­) ====== */
function showToast(msg, type="ok"){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.background = (type==="warn") ? "#d9534f" : "var(--primary)";
  t.style.color = "#fff";
  t.style.opacity = "1";
  setTimeout(()=> t.style.opacity = "0", 2000);
}

function showModalForm(title, fields, onok){
  const backdrop = document.getElementById("sharedModalBackdrop");
  const box = document.getElementById("sharedModal");
  let html = `<h2 style="margin-top:0;color:var(--primary)">${title}</h2>`;
  fields.forEach(f=>{
    html += `<div style="margin:8px 0;text-align:right;">`;
    html += `<label style="font-weight:700;display:block;margin-bottom:6px">${f.label}</label>`;
    if(f.type==="select"){
      html += `<select id="field_${f.name}" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border)">`;
      f.options.forEach(opt=> html += `<option value="${opt.value}" ${opt.value==f.value?"selected":""}>${opt.text}</option>`);
      html += `</select>`;
    } else {
      html += `<input id="field_${f.name}" type="text" value="${f.value||""}" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border)">`;
    }
    html += `</div>`;
  });
  html += `<div style="text-align:left;margin-top:8px"><button class="btn btn-main" id="modalOK">Ø­ÙØ¸</button> <button class="btn btn-sec" id="modalCancel">Ø¥Ù„ØºØ§Ø¡</button></div>`;
  box.innerHTML = html;
  backdrop.style.display = "flex";
  document.getElementById("modalCancel").onclick = ()=> backdrop.style.display = "none";
  document.getElementById("modalOK").onclick = ()=> {
    const vals = {};
    fields.forEach(f=> vals[f.name] = document.getElementById(`field_${f.name}`).value);
    backdrop.style.display = "none";
    onok(vals);
  };
}

function showPrompt(title, label, placeholder, value, onok){
  showModalForm(title, [{name:"val", label:label, type:"text", value:value||""}], res => onok(res.val));
}

function showConfirm(title, msg, onyes){
  const backdrop = document.getElementById("sharedModalBackdrop");
  const box = document.getElementById("sharedModal");
  box.innerHTML = `<h2 style="margin-top:0;color:var(--primary)">${title}</h2><p>${msg}</p><div style="text-align:left;margin-top:8px"><button class="btn btn-main" id="yes">Ù†Ø¹Ù…</button> <button class="btn btn-sec" id="no">Ù„Ø§</button></div>`;
  backdrop.style.display = "flex";
  document.getElementById("no").onclick = ()=> backdrop.style.display = "none";
  document.getElementById("yes").onclick = ()=> { backdrop.style.display = "none"; if(onyes) onyes(); };
}

/* ====== ØªØ®Ø²ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„ØµÙ ÙˆØ§Ù„Ø·Ø§Ù„Ø¨ ====== */
function storageKey(){
  const cls = localStorage.getItem("className") || "class";
  const student = localStorage.getItem("studentName") || "student";
  return `dictionary_${cls}_${student}`;
}

/* ====== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ ====== */
let dictionary = [];
function loadDictionary(){
  try{ const raw = localStorage.getItem(storageKey()); dictionary = raw ? JSON.parse(raw) : []; if(!Array.isArray(dictionary)) dictionary = []; }
  catch(e){ dictionary = []; }
}
function saveDictionary(){ localStorage.setItem(storageKey(), JSON.stringify(dictionary)); }

/* ====== Ø¹Ù†Ø§ØµØ± DOM ====== */
const tbody = document.querySelector("#dictionaryTable tbody");
const wordCount = document.getElementById("wordCount");
const selectAllBox = document.getElementById("selectAll");
const autoCapBox = document.getElementById("autoCap");
const fileInput = document.getElementById("fileInput");

/* ====== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© ====== */
(function setHeader(){
  const cls = localStorage.getItem("className") || "";
  const student = localStorage.getItem("studentName") || "";
  document.getElementById("headerSub").textContent = (cls && student) ? `Ø§Ù„ØµÙ: ${cls} â€” Ø§Ù„Ø·Ø§Ù„Ø¨: ${student}` : "";
})();

/* ====== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ====== */
function capitalizeFirst(s){ if(!s) return s; s = s.trim(); return s.charAt(0).toUpperCase() + s.slice(1); }
function ensureSentencePunctuation(s){ if(!s) return s; s = s.trim(); if(/[.!ØŸ!?]$/.test(s)) return s; return s + "."; }
function normalizeKey(w){ return w.trim().toLowerCase(); }
function existsWord(word){ const key = normalizeKey(word); return dictionary.some(e => normalizeKey(e.word) === key); }

/* ====== Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ====== */
function renderTable(){
  tbody.innerHTML = "";
  dictionary.forEach((entry, idx)=>{
    const tr = document.createElement("tr");

    // Ø§Ø®ØªÙŠØ§Ø±
    const tdCheck = document.createElement("td"); tdCheck.className = "check-col";
    const cb = document.createElement("input"); cb.type = "checkbox"; cb.dataset.idx = idx;
    tdCheck.appendChild(cb); tr.appendChild(tdCheck);

    // Ø±Ù‚Ù…
    const tdNum = document.createElement("td"); tdNum.className = "num-col"; tdNum.textContent = idx+1; tr.appendChild(tdNum);

    // ÙƒÙ„Ù…Ø©
    const tdWord = document.createElement("td"); tdWord.className = "word-col"; tdWord.textContent = entry.word; tr.appendChild(tdWord);

    // Ù…Ø¹Ù†Ù‰
    const tdMeaning = document.createElement("td"); tdMeaning.className = "meaning-col"; tdMeaning.textContent = entry.meaning; tr.appendChild(tdMeaning);

    // Ø¬Ù…Ù„Ø© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
    const tdEng = document.createElement("td"); tdEng.className = "eng-sentence-col"; tdEng.textContent = entry.sentence || ""; tr.appendChild(tdEng);

    // ØªØ±Ø¬Ù…Ø©
    const tdAr = document.createElement("td"); tdAr.className = "ar-sentence-col"; tdAr.textContent = entry.translation || ""; tr.appendChild(tdAr);

    // ÙˆØ¸Ø§Ø¦Ù
    const tdActions = document.createElement("td"); tdActions.className = "actions-col";
    // Ù†Ø·Ù‚ ÙƒÙ„Ù…Ø©
    const speakBtn = document.createElement("button"); speakBtn.className = "icon-btn"; speakBtn.title = `Ù†Ø·Ù‚ ${entry.word}`; speakBtn.textContent = "ğŸ”Š";
    speakBtn.onclick = ()=> speak(entry.word);
    tdActions.appendChild(speakBtn);
    // Ù†Ø·Ù‚ Ø¬Ù…Ù„Ø©
    const speakS = document.createElement("button"); speakS.className = "icon-btn"; speakS.title = "Ù†Ø·Ù‚ Ø§Ù„Ø¬Ù…Ù„Ø©"; speakS.textContent = "ğŸ”ˆ";
    speakS.onclick = ()=> { if(entry.sentence && entry.sentence.trim()!=="") speak(entry.sentence); else showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù…Ù„Ø©", "warn"); };
    tdActions.appendChild(speakS);
    // ØªØ¹Ø¯ÙŠÙ„
    const editBtn = document.createElement("button"); editBtn.className = "icon-btn"; editBtn.title = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø·Ø±"; editBtn.textContent = "âœï¸";
    editBtn.onclick = ()=> openEditModal(idx);
    tdActions.appendChild(editBtn);
    // Ø­Ø°Ù
    const delBtn = document.createElement("button"); delBtn.className = "icon-btn"; delBtn.title = "Ø­Ø°Ù"; delBtn.textContent = "âŒ";
    delBtn.onclick = ()=> showConfirm("Ø­Ø°Ù ÙƒÙ„Ù…Ø©", `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù "${entry.word}"ØŸ`, ()=> { dictionary.splice(idx,1); saveDictionary(); renderTable(); showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù"); });
    tdActions.appendChild(delBtn);

    tr.appendChild(tdActions);
    tbody.appendChild(tr);
  });
  wordCount.textContent = dictionary.length;
  selectAllBox.checked = false;
}

/* ====== Ø§Ù„Ù†Ø·Ù‚ ====== */
function speak(text){
  if(!window.speechSynthesis){ showToast("Ù…ÙŠØ²Ø© Ø§Ù„Ù†Ø·Ù‚ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©", "warn"); return; }
  const s = JSON.parse(localStorage.getItem("appSettings")||"{}");
  const u = new SpeechSynthesisUtterance(text);
  u.lang = s.accent || "en-GB";
  u.rate = parseFloat(s.rate || "1");
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

/* ====== Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ù…Ø© (Ù…ÙˆØ¯Ø§Ù„) ====== */
document.getElementById("openAddModal").onclick = ()=> {
  const positions = [{value:'end', text:'ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©'}];
  for(let i=0;i<dictionary.length;i++) positions.push({value:String(i), text:`Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø·Ø± ${i+1}`});
  showModalForm("Ø£Ø¶Ù ÙƒÙ„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©", [
    {name:"word", label:"Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", type:"text", value:""},
    {name:"meaning", label:"Ø§Ù„Ù…Ø¹Ù†Ù‰ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ", type:"text", value:""},
    {name:"sentence", label:"Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", type:"text", value:""},
    {name:"translation", label:"ØªØ±Ø¬Ù…Ø©/ØªÙˆØ¶ÙŠØ­ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", type:"text", value:""},
    {name:"pos", label:"Ù…ÙƒØ§Ù† Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬", type:"select", options: positions, value:"end"}
  ], vals=>{
    let w = vals.word.trim(), m = vals.meaning.trim(), s = vals.sentence.trim(), t = vals.translation.trim();
    if(!w||!m){ showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ„Ù…Ø© ÙˆØ§Ù„Ù…Ø¹Ù†Ù‰", "warn"); return; }
    if(autoCapBox.checked){ w = capitalizeFirst(w); s = ensureSentencePunctuation(capitalizeFirst(s)); }
    if(existsWord(w)){ showToast("Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„", "warn"); return; }
    const entry = {word:w, meaning:m, sentence:s, translation:t};
    if(vals.pos==='end') dictionary.push(entry); else dictionary.splice(parseInt(vals.pos,10)+1,0,entry);
    saveDictionary(); renderTable(); showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
  });
};

/* ====== Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ØµÙÙˆÙ ====== */
document.getElementById("insertHereBtn").onclick = ()=> {
  const positions = [{value:'end', text:'ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©'}];
  for(let i=0;i<dictionary.length;i++) positions.push({value:String(i), text:`Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø·Ø± ${i+1}`});
  showModalForm("Ø£Ø¶Ù ÙÙŠ Ù…ÙˆØ¶Ø¹ Ù…Ø­Ø¯Ø¯", [
    {name:"pos", label:"Ø§Ø®ØªØ± Ø§Ù„Ù…ÙƒØ§Ù†", type:"select", options: positions},
    {name:"word", label:"Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", type:"text"},
    {name:"meaning", label:"Ø§Ù„Ù…Ø¹Ù†Ù‰ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ", type:"text"},
    {name:"sentence", label:"Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", type:"text"},
    {name:"translation", label:"ØªØ±Ø¬Ù…Ø©/ØªÙˆØ¶ÙŠØ­ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", type:"text"}
  ], vals=>{
    if(!vals.word||!vals.meaning){ showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ„Ù…Ø© ÙˆØ§Ù„Ù…Ø¹Ù†Ù‰", "warn"); return; }
    let w = vals.word.trim(), m = vals.meaning.trim(), s = vals.sentence?vals.sentence.trim():"", t = vals.translation?vals.translation.trim():"";
    if(autoCapBox.checked){ w = capitalizeFirst(w); s = ensureSentencePunctuation(capitalizeFirst(s)); }
    if(existsWord(w)){ showToast("Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„", "warn"); return; }
    if(vals.pos==='end') dictionary.push({word:w, meaning:m, sentence:s, translation:t});
    else dictionary.splice(parseInt(vals.pos,10)+1,0,{word:w, meaning:m, sentence:s, translation:t});
    saveDictionary(); renderTable(); showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
  });
};

/* ====== ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø·Ø± ÙƒØ§Ù…Ù„ ====== */
function openEditModal(index){
  const e = dictionary[index];
  showModalForm("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ„Ù…Ø©", [
    {name:"word", label:"Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", type:"text", value:e.word},
    {name:"meaning", label:"Ø§Ù„Ù…Ø¹Ù†Ù‰ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ", type:"text", value:e.meaning},
    {name:"sentence", label:"Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", type:"text", value:e.sentence||""},
    {name:"translation", label:"ØªØ±Ø¬Ù…Ø©/ØªÙˆØ¶ÙŠØ­ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ", type:"text", value:e.translation||""}
  ], vals=>{
    let w = vals.word.trim(), m = vals.meaning.trim(), s = vals.sentence.trim(), t = vals.translation.trim();
    if(!w||!m){ showToast("Ø§Ù„ÙƒÙ„Ù…Ø© ÙˆØ§Ù„Ù…Ø¹Ù†Ù‰ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†", "warn"); return; }
    if(autoCapBox.checked){ w = capitalizeFirst(w); s = ensureSentencePunctuation(capitalizeFirst(s)); }
    const dup = dictionary.some((it,i)=> i!==index && normalizeKey(it.word)===normalizeKey(w));
    if(dup){ showToast("ÙŠÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙØ¹Ù„", "warn"); return; }
    dictionary[index] = {word:w, meaning:m, sentence:s, translation:t};
    saveDictionary(); renderTable(); showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸");
  });
}

/* ====== Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ / Ø­Ø°Ù Ø§Ù„ÙƒÙ„ ====== */
document.getElementById("deleteSelectedBtn").onclick = ()=> {
  const checked = Array.from(tbody.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>parseInt(cb.dataset.idx,10));
  if(checked.length===0){ showToast("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ ÙƒÙ„Ù…Ø©", "warn"); return; }
  showConfirm("Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯", `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ${checked.length} ÙƒÙ„Ù…Ø©ØŸ`, ()=> {
    checked.sort((a,b)=>b-a).forEach(i=>dictionary.splice(i,1));
    saveDictionary(); renderTable(); showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
  });
};
document.getElementById("clearAllBtn").onclick = ()=> {
  showConfirm("Ø­Ø°Ù Ø§Ù„ÙƒÙ„", "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§ØªØŸ", ()=> {
    dictionary = []; saveDictionary(); renderTable(); showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
  });
};

/* ====== ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ ====== */
selectAllBox.addEventListener("change", ()=> {
  const checked = selectAllBox.checked;
  tbody.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = checked);
});

/* ====== ØªØµØ¯ÙŠØ± JSON & XML (Ù…ØµØ­Ø­Ø©) ====== */
function currentFilenameBase(){
  const cls = (localStorage.getItem("className")||"class").replace(/\s+/g,'_');
  const student = (localStorage.getItem("studentName")||"student").replace(/\s+/g,'_');
  return `${cls}_${student}_${Date.now()}`;
}

function exportJSON(){
  if(dictionary.length===0){ showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±","warn"); return; }
  const data = JSON.stringify(dictionary, null, 2);
  const blob = new Blob([data], {type:"application/json;charset=utf-8"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
  a.download = `${currentFilenameBase()}.json`; a.click();
  URL.revokeObjectURL(a.href);
}

function exportXML(){
  if(dictionary.length===0){ showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±","warn"); return; }
  let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<dictionary>\n';
  dictionary.forEach(it=>{
    xml += `  <entry>\n    <word>${escapeXml(it.word)}</word>\n    <meaning>${escapeXml(it.meaning)}</meaning>\n    <sentence>${escapeXml(it.sentence||"")}</sentence>\n    <translation>${escapeXml(it.translation||"")}</translation>\n  </entry>\n`;
  });
  xml += '</dictionary>';
  const blob = new Blob([xml], {type:"application/xml;charset=utf-8"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
  a.download = `${currentFilenameBase()}.xml`; a.click();
  URL.revokeObjectURL(a.href);
}
function escapeXml(s){ if(!s) return ""; return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"); }

/* ÙˆØµÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
document.getElementById("exportJsonBtn").onclick = exportJSON;
document.getElementById("exportXmlBtn").onclick = exportXML;

/* ====== Ø§Ø³ØªÙŠØ±Ø§Ø¯: ÙŠØ³Ø£Ù„ Ø¯Ù…Ø¬ Ø£Ù… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ====== */
document.getElementById("importBtn").onclick = ()=> { fileInput.value=""; fileInput.click(); };
fileInput.addEventListener("change", async (ev)=>{
  const file = ev.target.files[0]; if(!file) return;
  showModalForm("Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯", [
    {name:"mode", label:"Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯", type:"select", options:[
      {value:"merge", text:"Ø¯Ù…Ø¬ â€” Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·"},
      {value:"replace", text:"Ø§Ø³ØªØ¨Ø¯Ø§Ù„ â€” Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„"}
    ], value:"merge"}
  ], async (vals)=>{
    const mode = vals.mode;
    const text = await file.text();
    try {
      let imported = [];
      if(file.name.toLowerCase().endsWith('.json')){
        imported = JSON.parse(text);
      } else if(file.name.toLowerCase().endsWith('.xml')){
        const parser = new DOMParser();
        const doc = parser.parseFromString(text,"application/xml");
        const nodes = Array.from(doc.querySelectorAll("entry"));
        imported = nodes.map(node=>({
          word: node.querySelector("word") ? node.querySelector("word").textContent : "",
          meaning: node.querySelector("meaning") ? node.querySelector("meaning").textContent : "",
          sentence: node.querySelector("sentence") ? node.querySelector("sentence").textContent : "",
          translation: node.querySelector("translation") ? node.querySelector("translation").textContent : ""
        }));
      } else {
        showToast("ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©", "warn"); return;
      }

      if(!Array.isArray(imported) || imported.length===0){ showToast("Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯","warn"); return; }

      if(mode === "replace"){
        dictionary = imported.filter(it => it.word && it.meaning).map(it => ({
          word: (autoCapBox.checked ? capitalizeFirst(it.word.trim()) : it.word.trim()),
          meaning: it.meaning.trim(),
          sentence: it.sentence ? it.sentence.trim() : "",
          translation: it.translation ? it.translation.trim() : ""
        }));
      } else {
        const existing = new Set(dictionary.map(d => normalizeKey(d.word)));
        imported.forEach(it=>{
          if(!it.word || !it.meaning) return;
          const w = (autoCapBox.checked ? capitalizeFirst(it.word.trim()) : it.word.trim());
          if(!existing.has(normalizeKey(w))){
            dictionary.push({word:w, meaning:it.meaning.trim(), sentence:it.sentence?it.sentence.trim():"", translation:it.translation?it.translation.trim():""});
            existing.add(normalizeKey(w));
          }
        });
      }

      saveDictionary(); renderTable(); showToast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­");
    } catch(err){
      console.error(err);
      showToast("ØªØ¹Ø°Ø± Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„ÙØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙŠØºØ©","warn");
    }
  });
});

/* ====== Ù…Ø³Ø§Ø¹Ø¯Ø©: ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ ====== */
loadDictionary(); renderTable();

/* ====== Ø¶Ø¨Ø· autoCap Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ù† ÙˆÙØ¬Ø¯Øª ====== */
(function initAutoCap(){
  const s = JSON.parse(localStorage.getItem("appSettings")||"{}");
  autoCapBox.checked = s.autoCap !== false;
})();

/* ====== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ø£Ø®Ø±Ù‰ ====== */
function downloadBlob(blob, filename){
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  URL.revokeObjectURL(a.href);
}

/* ====== Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø³ÙŠØ·Ø© ====== */
document.getElementById("backHome").onclick = ()=> location.href = "index.html";

/* ====== ÙˆØ¸Ø§Ø¦Ù Ø¹Ø±Ø¶/ØªØ­Ù‚Ù‚ Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ ====== */
window.addEventListener("load", () => {
  // Ù„Ø§ Ø´ÙŠØ¡ Ø¥Ø¶Ø§ÙÙŠ Ù‡Ù†Ø§ Ø­Ø§Ù„ÙŠÙ‹Ø§
});

/* ====== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù†ØµÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ø£Ø¹Ù„Ø§Ù‡ Ù…Ø°ÙƒÙˆØ±Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹ ====== */

/* ========== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³ÙƒØ±Ø¨Øª ========== */
</script>
</body>
</html>

